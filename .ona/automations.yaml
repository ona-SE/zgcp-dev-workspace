services:
  # Telepresence daemon - maintains cluster connection
  telepresence-daemon:
    name: Telepresence Daemon
    description: Maintains connection to ZGCP cluster
    triggeredBy:
      - postEnvironmentStart
    commands:
      start: |
        # Wait for kubeconfig to be configured
        until kubectl cluster-info &>/dev/null; do
          echo "Waiting for cluster access..."
          sleep 5
        done
        telepresence connect
      stop: telepresence quit

tasks:
  # Configure kubectl with Okta OIDC
  setup-cluster-access:
    name: Configure Cluster Access
    description: Authenticate to ZGCP cluster via Okta
    triggeredBy:
      - postEnvironmentStart
    command: |
      echo "Configuring kubectl for cluster: ${ZGCP_TARGET_CLUSTER:-nonprod-cluster}"
      kubectl-oidc_login setup \
        --oidc-issuer-url=https://zillow.okta.com \
        --oidc-client-id=${OKTA_CLIENT_ID} \
        --oidc-extra-scope=groups
      echo "Cluster access configured. Run 'kubectl get pods' to verify."

  # Start remocal intercept for the service
  start-intercept:
    name: Start Remocal Intercept
    description: Intercept traffic from review environment to local process
    command: |
      SERVICE_NAME=${ZGCP_ZODIAC_SERVICE:-my-service}
      NAMESPACE=${ZGCP_REVIEW_NAMESPACE:-${SERVICE_NAME}-review-${MR_ID}}

      echo "Starting intercept for ${SERVICE_NAME} in ${NAMESPACE}..."
      telepresence intercept ${SERVICE_NAME} \
        --namespace ${NAMESPACE} \
        --port 8080:8080 \
        --env-file .env.cluster
      echo "Intercept active. Cluster env vars written to .env.cluster"

  # Run Playwright tests against review environment  
  run-e2e-tests:
    name: Run E2E Tests
    description: Execute Playwright tests against the review environment
    command: |
      export BASE_URL="https://${ZGCP_REVIEW_NAMESPACE}.review.zgcp.zillow.net"
      npx playwright test --project=chromium
